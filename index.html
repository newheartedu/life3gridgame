import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  getDocs,
  collection, 
  onSnapshot, 
  query, 
  where,
  updateDoc
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  signOut,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  fetchSignInMethodsForEmail
} from 'firebase/auth';
import { 
  CheckCircle2, 
  User, 
  ShieldCheck, 
  LogOut, 
  LayoutGrid,
  Loader2,
  ChevronRight,
  ArrowLeft,
  Trophy,
  BarChart3,
  Users,
  KeyRound,
  AlertTriangle,
  Mail,
  Copy
} from 'lucide-react';

// --- Firebase åˆå§‹åŒ– ---
const firebaseConfig = {
  apiKey: "AIzaSyByt0w_VbguiifETHkpUyJoxuCS_LyIVpY",
  authDomain: "life3grid.firebaseapp.com",
  projectId: "life3grid",
  storageBucket: "life3grid.firebasestorage.app",
  messagingSenderId: "1091079634646",
  appId: "1:1091079634646:web:ca46d336d28d6690f6d377"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = 'life3-mission-grid-v2'; 

// --- å¸¸æ•¸è¨­å®š ---
const ALLIANCES = ['å¤¢å¹»', 'Favor', 'å¿ƒä¸è€', 'é¡å€¼', 'Revival'];
const DEFAULT_TASKS = [
  "æ¢è¨ª 3 å€‹äºº",
  "å®Œæˆä¸€é€±è®€ç¶“è¨ˆç•«",
  "ç‚ºä¸€ä½æœ‹å‹ç¦±å‘Š",
  "åƒåŠ ä¸€æ¬¡å°çµ„èšæœƒ",
  "ä¸»å‹•é—œå¿ƒä¸€ä½æ–°äºº",
  "å¯«ä¸‹ 3 ä»¶æ„Ÿæ©äº‹é …",
  "å®Œæˆä¸€æ¬¡ç¦é£Ÿç¦±å‘Š",
  "å‚³ç¦éŸ³çµ¦ä¸€å€‹äºº",
  "å®‰éœéˆä¿® 30 åˆ†é˜"
];

const ADMIN_CREDENTIALS = {
  account: 'life3',
  password: 'life3'
};

// --- å…±ç”¨çµ„ä»¶ ---

const LoadingScreen = ({ message = "ç³»çµ±é€£ç·šä¸­..." }) => (
  <div className="flex flex-col items-center justify-center min-h-screen bg-orange-50">
    <Loader2 className="w-10 h-10 text-orange-500 animate-spin mb-4" />
    <p className="text-orange-700 font-black tracking-tight">{message}</p>
  </div>
);

const ErrorScreen = ({ error, onRetry }) => {
  const currentDomain = window.location.hostname;
  const [copied, setCopied] = useState(false);

  const copyDomain = () => {
    navigator.clipboard.writeText(currentDomain);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-red-50 p-6">
      <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full border border-red-100 text-center">
        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <AlertTriangle className="text-red-600 w-8 h-8" />
        </div>
        <h2 className="text-2xl font-black text-slate-800 mb-2">ç™¼ç”ŸéŒ¯èª¤</h2>
        <p className="text-slate-600 font-bold mb-6 text-sm leading-relaxed">
          {error}
        </p>
        
        {error.includes("auth/operation-not-allowed") && (
          <div className="bg-slate-50 p-4 rounded-xl text-left text-xs text-slate-500 space-y-2 mb-6 border border-slate-100">
            <p className="font-black text-slate-700 mb-2">ğŸ”§ è¨­å®šæ•™å­¸ (Firebase Console):</p>
            <ol className="list-decimal list-inside space-y-1 ml-1">
              <li>å‰å¾€ Firebase Console &gt; Authentication</li>
              <li>é»é¸ <strong>Sign-in method</strong></li>
              <li>å•Ÿç”¨ <strong>Email/Password</strong></li>
            </ol>
          </div>
        )}

        <button 
          onClick={onRetry || (() => window.location.reload())}
          className="w-full bg-red-500 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-red-600 transition-all active:scale-95 flex items-center justify-center gap-2 mt-4"
        >
          æˆ‘å·²è¨­å®šå®Œæˆï¼Œé‡è©¦
        </button>
      </div>
    </div>
  );
};

const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('auth'); // auth, register, grid, admin_login, admin_dashboard, forgot_password
  const [loading, setLoading] = useState(true);
  const [authError, setAuthError] = useState(null);
  const [profile, setProfile] = useState(null);
  const [userTasks, setUserTasks] = useState(new Array(9).fill(false));
  const [allUsers, setAllUsers] = useState([]);
  const [selectedUser, setSelectedUser] = useState(null);
  const [adminTab, setAdminTab] = useState('rank');

  // æ§åˆ¶æ˜¯å¦è‡ªå‹•è¼‰å…¥
  const isFirstLoad = useRef(true);

  // è¡¨å–®ç‹€æ…‹
  const [formData, setFormData] = useState({ 
    name: '', 
    email: '',
    alliance: ALLIANCES[0], 
    group: '', 
    password: '' 
  });
  
  const [loginData, setLoginData] = useState({ email: '', password: '' });
  const [adminLoginData, setAdminLoginData] = useState({ account: '', password: '' });
  const [forgotData, setForgotData] = useState({ email: '' });
  const [error, setError] = useState('');
  const [successMsg, setSuccessMsg] = useState('');

  // 1. èº«ä»½é©—è­‰ç›£è½
  useEffect(() => {
    let mounted = true;
    
    // ç›£è½ Auth ç‹€æ…‹æ”¹è®Š
    const unsubscribe = onAuthStateChanged(auth, async (u) => {
      if (!mounted) return;
      
      setUser(u);
      
      if (u) {
        // å¦‚æœä½¿ç”¨è€…å·²ç™»å…¥ï¼Œå˜—è©¦è®€å– Profile
        try {
          const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', u.uid);
          const profileSnap = await getDoc(profileRef);
          
          if (profileSnap.exists()) {
            const data = profileSnap.data();
            setProfile(data);
            setUserTasks(data.tasks || new Array(9).fill(false));
            
            // å¦‚æœæ˜¯åœ¨ç™»å…¥/è¨»å†Šé é¢ï¼Œè‡ªå‹•è·³è½‰
            if (['auth', 'register'].includes(view)) {
              setView('grid');
            }
          } else {
            // å·²ç™»å…¥ä½†æ²’æœ‰ Profile (ç•°å¸¸ç‹€æ…‹ï¼Œæˆ–æ˜¯è¨»å†Šä¸­)
            setProfile(null);
          }
        } catch (err) {
          console.error("Profile fetch error:", err);
        }
      }
      
      setLoading(false);
    });

    return () => {
      mounted = false;
      unsubscribe();
    };
  }, [view]); // View ä¾è³´æ˜¯ç”¨ä¾†è™•ç†è·³è½‰é‚è¼¯

  // 3. ç®¡ç†è€…æ•¸æ“šç›£è½
  useEffect(() => {
    // é—œéµä¿®æ­£ï¼šç¢ºä¿ user å­˜åœ¨æ™‚æ‰é–‹å§‹ç›£è½ï¼Œé€™æ¨£ onSnapshot æ‰æœƒé‹ä½œ
    if (view !== 'admin_dashboard' || !user) return;

    const profilesCol = collection(db, 'artifacts', appId, 'public', 'data', 'profiles');
    const unsubscribe = onSnapshot(profilesCol, (snapshot) => {
      const users = [];
      snapshot.forEach((doc) => {
        users.push({ id: doc.id, ...doc.data() });
      });
      setAllUsers(users);
    }, (err) => {
      console.error("Admin dashboard sync error:", err);
    });

    return () => unsubscribe();
  }, [view, user]);

  // --- çµ±è¨ˆæ’è¡Œæ¦œ ---
  const allianceStats = useMemo(() => {
    const stats = ALLIANCES.map(name => ({
      name,
      userCount: 0,
      completedTasks: 0,
      totalPossibleTasks: 0,
      completionRate: 0
    }));

    allUsers.forEach(u => {
      const idx = ALLIANCES.indexOf(u.alliance);
      if (idx !== -1) {
        stats[idx].userCount += 1;
        const done = u.tasks ? u.tasks.filter(v => v).length : 0;
        stats[idx].completedTasks += done;
        stats[idx].totalPossibleTasks += 9;
      }
    });

    return stats.map(s => ({
      ...s,
      completionRate: s.totalPossibleTasks > 0 ? (s.completedTasks / s.totalPossibleTasks) * 100 : 0
    })).sort((a, b) => b.completionRate - a.completionRate);
  }, [allUsers]);

  // --- æ ¸å¿ƒè™•ç†åŠŸèƒ½ ---

  // Email è¨»å†Š
  const handleRegister = async (e) => {
    e.preventDefault();
    if (!formData.name || !formData.email || !formData.password || !formData.group) {
      setError('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
      return;
    }
    setError('');
    setLoading(true);
    
    try {
      // 1. å»ºç«‹ Firebase Auth ä½¿ç”¨è€…
      const userCredential = await createUserWithEmailAndPassword(auth, formData.email, formData.password);
      const newUser = userCredential.user;

      // 2. å»ºç«‹ Firestore Profile
      const profileData = {
        uid: newUser.uid,
        name: formData.name,
        loginName: formData.email, // ä½¿ç”¨ Email ä½œç‚ºç™»å…¥è­˜åˆ¥
        email: formData.email,
        alliance: formData.alliance,
        group: formData.group,
        tasks: new Array(9).fill(false),
        updatedAt: Date.now(),
        authProvider: 'email'
      };

      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', newUser.uid), profileData);
      
      setProfile(profileData);
      setUserTasks(profileData.tasks);
      setView('grid');
    } catch (err) {
      console.error(err);
      if (err.code === 'auth/email-already-in-use') {
        setError('æ­¤ Email å·²è¢«è¨»å†Š');
      } else if (err.code === 'auth/weak-password') {
        setError('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 å€‹å­—å…ƒ');
      } else {
        setError(`è¨»å†Šå¤±æ•—: ${err.message}`);
      }
    } finally {
      setLoading(false);
    }
  };

  // Email ç™»å…¥
  const handleLogin = async (e) => {
    e.preventDefault();
    setError('');
    
    if (!loginData.email || !loginData.password) {
      setError('è«‹è¼¸å…¥ Email å’Œå¯†ç¢¼');
      return;
    }

    setLoading(true);
    try {
      await signInWithEmailAndPassword(auth, loginData.email, loginData.password);
      // onAuthStateChanged æœƒè™•ç†è·³è½‰
    } catch (err) {
      console.error(err);
      if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
        setError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
      } else if (err.code === 'auth/too-many-requests') {
        setError('ç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦');
      } else {
        setError(`ç™»å…¥å¤±æ•—: ${err.message}`);
      }
      setLoading(false);
    }
  };

  const handleForgotPassword = async (e) => {
    e.preventDefault();
    setError('');
    setSuccessMsg('');
    
    try {
      const profilesCol = collection(db, 'artifacts', appId, 'public', 'data', 'profiles');
      const q = query(profilesCol, where('email', '==', forgotData.email));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        // ç°¡æ˜“é©—è­‰æç¤º
        setSuccessMsg(`è«‹æŸ¥çœ‹æ‚¨çš„ä¿¡ç®±ä»¥é‡è¨­å¯†ç¢¼ (æ¨¡æ“¬åŠŸèƒ½)`);
      } else {
        setError('æ‰¾ä¸åˆ°æ­¤ Email çš„è¨»å†Šè³‡æ–™');
      }
    } catch (err) {
      setError('æŸ¥è©¢å¤±æ•—');
    }
  };

  const handleToggleTask = async (index) => {
    if (!profile || !user) return;
    
    const newTasks = [...userTasks];
    newTasks[index] = !newTasks[index];
    setUserTasks(newTasks);

    try {
      const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', user.uid);
      await updateDoc(profileRef, {
        tasks: newTasks,
        updatedAt: Date.now()
      });
    } catch (err) {
      console.error("Save error:", err);
    }
  };

  // é—œéµä¿®æ­£ï¼šç®¡ç†è€…ç™»å…¥é‚è¼¯
  const handleAdminLogin = async (e) => {
    e.preventDefault();
    if (adminLoginData.account === ADMIN_CREDENTIALS.account && 
        adminLoginData.password === ADMIN_CREDENTIALS.password) {
      
      setLoading(true);
      try {
        // å¦‚æœç›®å‰æ²’æœ‰ç™»å…¥ä»»ä½• Firebase ç”¨æˆ¶ï¼Œå‰‡é€²è¡ŒåŒ¿åç™»å…¥
        // é€™æ˜¯ç‚ºäº†é€šé Firestore çš„å®‰å…¨è¦å‰‡ (if !user return é‚è¼¯)
        if (!auth.currentUser) {
           await signInAnonymously(auth);
        }
        
        setView('admin_dashboard');
        setError('');
      } catch (err) {
        console.error("Admin auth failed:", err);
        setError('å¾Œå°é€£ç·šé©—è­‰å¤±æ•—');
      } finally {
        setLoading(false);
      }

    } else {
      setError('ç®¡ç†è€…å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
    }
  };

  const logout = async () => {
    setLoading(true);
    try {
      await signOut(auth);
      setProfile(null);
      setUserTasks(new Array(9).fill(false));
      setSelectedUser(null);
      setAllUsers([]);
      setError('');
      setSuccessMsg('');
      setLoginData({ email: '', password: '' });
      setView('auth');
    } catch (err) {
      console.error("Logout failed:", err);
    } finally {
      setLoading(false);
    }
  };

  if (authError) return <ErrorScreen error={authError} onRetry={() => setAuthError(null)} />;
  if (loading) return <LoadingScreen message="ç³»çµ±è™•ç†ä¸­..." />;

  return (
    <div className="min-h-screen bg-orange-50 text-slate-800 font-sans selection:bg-orange-200">
      <header className="bg-white border-b border-orange-100 px-6 py-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white shadow-md">
            <LayoutGrid size={20} />
          </div>
          <h1 className="font-bold text-lg tracking-tight text-slate-700">Life3 ä¹å®®æ ¼</h1>
        </div>
        
        {(profile || view === 'admin_dashboard' || view === 'admin_login' || view === 'forgot_password') && (
           <button 
             onClick={logout} 
             className="flex items-center gap-1 text-slate-400 hover:text-orange-600 transition-colors px-3 py-1 rounded-full hover:bg-orange-50 font-black"
           >
             <span className="text-sm">ç™»å‡º / è¿”å›</span>
             <LogOut size={18} />
           </button>
        )}
        
        {!profile && view === 'auth' && (
          <button onClick={() => setView('admin_login')} className="text-slate-300 text-[10px] font-black hover:text-slate-500 transition-colors uppercase tracking-widest">
            Admin
          </button>
        )}
      </header>

      <main className="max-w-md mx-auto p-6 pb-24">
        
        {/* --- ç™»å…¥é é¢ --- */}
        {view === 'auth' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center space-y-3 pt-8">
              <div className="inline-block px-3 py-1 rounded-full bg-orange-100 text-orange-600 text-[10px] font-black tracking-widest uppercase mb-2">Christian Youth</div>
              <h2 className="text-4xl font-black text-slate-800 leading-tight">Life3<br/>ä¹å®®æ ¼ä»»å‹™</h2>
              <p className="text-slate-500 font-medium tracking-tight font-bold">ä¿¡ä»°å¯¦è¸ï¼Œå¾æ¯ä¸€æ ¼æŒ‘æˆ°é–‹å§‹</p>
            </div>
            
            <div className="bg-white p-7 rounded-[2.5rem] shadow-2xl shadow-orange-200/40 border border-orange-100 space-y-6">
              <form onSubmit={handleLogin} className="space-y-4">
                <div>
                  <label className="block text-sm font-black text-slate-600 mb-1 ml-1">Email</label>
                  <input 
                    type="email" 
                    className="w-full px-5 py-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-orange-500 focus:bg-white transition-all outline-none font-bold text-lg"
                    placeholder="name@example.com"
                    value={loginData.email}
                    onChange={(e) => setLoginData({...loginData, email: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-black text-slate-600 mb-1 ml-1 flex justify-between">
                    å¯†ç¢¼
                    <button type="button" onClick={() => setView('forgot_password')} className="text-xs text-orange-400 hover:text-orange-600 font-bold">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
                  </label>
                  <input 
                    type="password" 
                    className="w-full px-5 py-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-orange-500 focus:bg-white transition-all outline-none font-bold text-lg"
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                    value={loginData.password}
                    onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                  />
                </div>
                
                {error && <p className="text-red-500 text-xs text-center font-black bg-red-50 py-2 rounded-lg">{error}</p>}
                
                <button type="submit" className="w-full bg-orange-500 hover:bg-orange-600 text-white font-black py-4 rounded-2xl shadow-xl shadow-orange-300 transition-all active:scale-[0.97] mt-2 flex items-center justify-center gap-2">
                  <Mail size={18} />
                  Email ç™»å…¥
                </button>
              </form>
            </div>

            <div className="text-center">
              <button 
                onClick={() => setView('register')} 
                className="text-slate-400 text-sm font-black hover:text-orange-600 transition-colors"
              >
                ç¬¬ä¸€æ¬¡åƒåŠ ï¼Ÿä½¿ç”¨ Email è¨»å†Š
              </button>
            </div>
          </div>
        )}

        {/* --- å¿˜è¨˜å¯†ç¢¼ --- */}
        {view === 'forgot_password' && (
           <div className="space-y-8 animate-in fade-in zoom-in-95 duration-500 pt-8">
              <div className="text-center">
                 <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner">
                    <KeyRound className="text-orange-600" />
                 </div>
                 <h2 className="text-2xl font-black text-slate-800">æ‰¾å›å¯†ç¢¼</h2>
                 <p className="text-slate-400 text-sm font-bold mt-1">è«‹è¼¸å…¥ Email é€²è¡ŒæŸ¥è©¢</p>
              </div>
              <form onSubmit={handleForgotPassword} className="space-y-4 bg-white p-7 rounded-[2.5rem] shadow-xl border border-orange-100">
                <input 
                  type="email" 
                  placeholder="è¨»å†Šæ™‚å¡«å¯«çš„ Email"
                  className="w-full px-5 py-4 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-orange-500 outline-none font-bold"
                  value={forgotData.email}
                  onChange={(e) => setForgotData({...forgotData, email: e.target.value})}
                />
                {error && <p className="text-red-500 text-xs text-center font-black py-2 bg-red-50 rounded-lg">{error}</p>}
                {successMsg && <div className="p-4 bg-green-50 text-green-700 rounded-2xl text-center font-black text-lg border border-green-200 shadow-sm animate-bounce">{successMsg}</div>}
                <button className="w-full bg-orange-500 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">é€å‡ºæŸ¥è©¢</button>
                <button type="button" onClick={() => setView('auth')} className="w-full text-slate-400 text-sm font-black font-bold">è¿”å›ç™»å…¥</button>
              </form>
           </div>
        )}

        {/* --- è¨»å†Šé é¢ --- */}
        {view === 'register' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center space-y-2 pt-4">
              <h2 className="text-3xl font-black text-slate-800">å»ºç«‹æŒ‘æˆ°å¸³è™Ÿ</h2>
              <p className="text-slate-500 text-sm font-bold tracking-tight">å¡«å¯«åŸºæœ¬è³‡æ–™ï¼Œå³åˆ»é–‹å§‹ä¹å®®æ ¼æŒ‘æˆ°</p>
            </div>
            
            <form onSubmit={handleRegister} className="space-y-4 bg-white p-7 rounded-[2.5rem] shadow-xl border border-orange-100">
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-black text-slate-600 mb-1 ml-1">çœŸå¯¦å§“å</label>
                  <input 
                    type="text" 
                    className="w-full px-5 py-3.5 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-orange-500 outline-none font-bold"
                    placeholder="å§“å"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-black text-slate-600 mb-1 ml-1">Email (å¸³è™Ÿ)</label>
                  <input 
                    type="email" 
                    className="w-full px-5 py-3.5 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-orange-500 outline-none font-bold"
                    placeholder="example@mail.com"
                    value={formData.email}
                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-black text-slate-600 mb-1 ml-1">è¯ç›Ÿ</label>
                    <select 
                      className="w-full px-4 py-3.5 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-orange-500 outline-none appearance-none font-bold text-center"
                      value={formData.alliance}
                      onChange={(e) => setFormData({...formData, alliance: e.target.value})}
                    >
                      {ALLIANCES.map(a => <option key={a} value={a}>{a}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-black text-slate-600 mb-1 ml-1">å°çµ„</label>
                    <input 
                      type="text" 
                      className="w-full px-5 py-3.5 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-orange-500 outline-none font-bold text-center"
                      placeholder="å°çµ„å"
                      value={formData.group}
                      onChange={(e) => setFormData({...formData, group: e.target.value})}
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-black text-slate-600 mb-1 ml-1">è¨­å®šå¯†ç¢¼</label>
                  <input 
                    type="password" 
                    className="w-full px-5 py-3.5 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-orange-500 outline-none font-bold"
                    placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                    value={formData.password}
                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                  />
                </div>
              </div>
              {error && <p className="text-red-500 text-xs text-center font-black py-2 bg-red-50 rounded-lg">{error}</p>}
              <button type="submit" className="w-full bg-orange-500 hover:bg-orange-600 text-white font-black py-4 rounded-2xl shadow-lg transition-all active:scale-95">
                å»ºç«‹å¸³è™Ÿä¸¦ç™»å…¥
              </button>
              <button type="button" onClick={() => setView('auth')} className="w-full text-slate-400 font-bold text-sm py-2">è¿”å›ç™»å…¥</button>
            </form>
          </div>
        )}

        {/* --- ä¹å®®æ ¼ä»»å‹™ç•«é¢ (ç¶­æŒä¸è®Š) --- */}
        {view === 'grid' && profile && (
          <div className="space-y-6 animate-in fade-in duration-700">
            <div className="bg-white p-5 rounded-3xl border border-orange-100 shadow-xl shadow-orange-100/30 flex items-center justify-between">
              <div>
                <div className="flex items-center gap-1.5 mb-1">
                   <span className="px-2 py-0.5 bg-orange-500 text-white text-[9px] font-black rounded-md">{profile.alliance}</span>
                   <span className="text-[10px] font-black text-slate-400">{profile.group}</span>
                </div>
                <h3 className="text-2xl font-black text-slate-800">{profile.name} <span className="text-lg font-medium text-slate-500 ml-1">æŒ‘æˆ°ä¸­</span></h3>
              </div>
              <div className="relative flex items-center justify-center">
                 <svg className="w-16 h-16 transform -rotate-90">
                    <circle cx="32" cy="32" r="28" stroke="currentColor" strokeWidth="4" fill="transparent" className="text-slate-100" />
                    <circle cx="32" cy="32" r="28" stroke="currentColor" strokeWidth="4" fill="transparent" strokeDasharray={176} strokeDashoffset={176 - (176 * userTasks.filter(v => v).length / 9)} className="text-orange-500 transition-all duration-1000 ease-out" />
                 </svg>
                 <div className="absolute flex flex-col items-center">
                    <span className="text-xl font-black text-slate-800 leading-none">{userTasks.filter(v => v).length}</span>
                    <span className="text-[9px] font-black text-slate-400">/ 9</span>
                 </div>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-4 aspect-square">
              {DEFAULT_TASKS.map((task, idx) => (
                <button
                  key={idx}
                  onClick={() => handleToggleTask(idx)}
                  className={`
                    relative p-4 rounded-3xl flex flex-col items-center justify-center text-center transition-all duration-300
                    ${userTasks[idx] 
                      ? 'bg-orange-500 text-white shadow-xl shadow-orange-300 ring-4 ring-orange-50 scale-[0.98]' 
                      : 'bg-white text-slate-700 border-2 border-orange-100 hover:border-orange-400 hover:shadow-md'}
                  `}
                >
                  <span className={`leading-snug font-black ${task.length > 8 ? 'text-lg' : 'text-xl'}`}>
                    {task}
                  </span>
                  {userTasks[idx] && (
                    <div className="absolute top-2 right-2">
                      <div className="w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-sm">
                         <CheckCircle2 size={14} className="text-orange-600 font-bold" />
                      </div>
                    </div>
                  )}
                </button>
              ))}
            </div>

            <button 
              onClick={logout}
              className="w-full flex items-center justify-center gap-2 bg-white border-2 border-orange-100 text-orange-500 font-black py-4 rounded-2xl hover:bg-orange-50 transition-all active:scale-95 shadow-sm"
            >
              <LogOut size={20} />
              ç™»å‡ºå¸³è™Ÿ
            </button>

            <div className="bg-orange-100/50 rounded-2xl p-5 text-center border border-orange-200/50">
               <p className="text-orange-800 text-sm font-black italic">â€œå‡¡ä½ æ‰‹æ‰€ç•¶ä½œçš„äº‹è¦ç›¡åŠ›å»ä½œã€‚â€ â€” å‚³é“æ›¸ 9:10</p>
            </div>
          </div>
        )}

        {/* --- ç®¡ç†è€…å€å¡Š --- */}
        {view === 'admin_login' && (
          <div className="space-y-8 animate-in zoom-in-95 duration-300 pt-10">
            <div className="text-center">
              <div className="w-16 h-16 bg-slate-100 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                 <ShieldCheck className="w-8 h-8 text-slate-700" />
              </div>
              <h2 className="text-2xl font-black text-slate-800">å¾Œå°ç®¡ç†ç™»å…¥</h2>
            </div>
            <form onSubmit={handleAdminLogin} className="space-y-4 bg-white p-7 rounded-[2.5rem] shadow-xl border border-slate-200">
              <input 
                type="text" 
                placeholder="ç®¡ç†å¸³è™Ÿ"
                className="w-full px-5 py-4 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-slate-500 outline-none font-black"
                value={adminLoginData.account}
                onChange={(e) => setAdminLoginData({...adminLoginData, account: e.target.value})}
              />
              <input 
                type="password" 
                placeholder="ç®¡ç†å¯†ç¢¼"
                className="w-full px-5 py-4 rounded-2xl bg-slate-50 border-none focus:ring-2 focus:ring-slate-500 outline-none font-black"
                value={adminLoginData.password}
                onChange={(e) => setAdminLoginData({...adminLoginData, password: e.target.value})}
              />
               {error && <p className="text-red-500 text-xs text-center font-black py-2 bg-red-50 rounded-lg">{error}</p>}
              <button className="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all">ç™»å…¥ä¸»æ§å°</button>
              <button type="button" onClick={() => setView('auth')} className="w-full text-slate-400 text-sm font-black">è¿”å›å‰å°</button>
            </form>
          </div>
        )}

        {/* ç®¡ç†è€… Dashboard (ç¶­æŒä¸è®Š) */}
        {view === 'admin_dashboard' && (
          <div className="space-y-6 animate-in slide-in-from-right-4 duration-500">
            {!selectedUser ? (
              <React.Fragment>
                <div className="flex items-center justify-between bg-white p-2 rounded-2xl border border-slate-100 shadow-sm">
                   <button 
                     onClick={() => setAdminTab('rank')}
                     className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 transition-all ${adminTab === 'rank' ? 'bg-orange-500 text-white shadow-md' : 'text-slate-400 hover:text-slate-600'}`}
                   >
                     <Trophy size={18} />
                     <span className="text-sm font-black">è¯ç›Ÿæ’è¡Œ</span>
                   </button>
                   <button 
                     onClick={() => setAdminTab('users')}
                     className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 transition-all ${adminTab === 'users' ? 'bg-orange-500 text-white shadow-md' : 'text-slate-400 hover:text-slate-600'}`}
                   >
                     <Users size={18} />
                     <span className="text-sm font-black">äººå“¡è©³æƒ…</span>
                   </button>
                </div>

                {adminTab === 'rank' ? (
                  <div className="space-y-6 animate-in fade-in duration-500">
                     <div className="bg-white p-6 rounded-[2.5rem] border border-orange-100 shadow-lg">
                        <h3 className="text-xl font-black text-slate-800 flex items-center gap-2 mb-6">
                           <BarChart3 className="text-orange-500" />
                           è¯ç›Ÿå®Œæˆåº¦æ’è¡Œæ¦œ
                        </h3>
                        <div className="space-y-8">
                           {allianceStats.map((s, idx) => (
                             <div key={s.name} className="relative">
                               <div className="flex justify-between items-end mb-2 px-1">
                                  <div className="flex items-center gap-2">
                                     <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-black ${idx === 0 ? 'bg-yellow-400 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                        {idx + 1}
                                     </span>
                                     <span className="font-black text-slate-700">{s.name} è¯ç›Ÿ</span>
                                  </div>
                                  <div className="text-right">
                                     <span className="text-[10px] text-slate-400 font-black block leading-none">{s.completedTasks}/{s.totalPossibleTasks} æ ¼</span>
                                     <span className="text-lg font-black text-orange-600 leading-none">{s.completionRate.toFixed(1)}%</span>
                                  </div>
                               </div>
                               <div className="w-full h-4 bg-slate-100 rounded-full overflow-hidden shadow-inner border border-slate-50">
                                  <div 
                                    className={`h-full transition-all duration-1000 ease-out rounded-full ${idx === 0 ? 'bg-gradient-to-r from-orange-400 to-orange-600 shadow-lg shadow-orange-200' : 'bg-orange-300'}`} 
                                    style={{ width: `${s.completionRate}%` }} 
                                  />
                               </div>
                               <p className="text-[9px] text-slate-400 mt-1 ml-1 font-black uppercase tracking-tighter">åƒèˆ‡äººæ•¸: {s.userCount} ä½é’å¹´</p>
                             </div>
                           ))}
                        </div>
                     </div>
                     
                     <div className="bg-slate-800 p-6 rounded-[2rem] text-white shadow-xl">
                        <div className="flex items-center justify-between mb-2">
                           <span className="text-slate-400 text-xs font-black uppercase tracking-widest">ç¸½åƒèˆ‡äººæ•¸</span>
                           <span className="text-3xl font-black">{allUsers.length}</span>
                        </div>
                        <div className="h-1.5 bg-slate-700 w-full rounded-full"></div>
                        <p className="text-[10px] text-slate-500 mt-3 font-bold">æ•¸æ“šåŒæ­¥ï¼š{new Date().toLocaleTimeString()} (å³æ™‚æ›´æ–°)</p>
                     </div>
                  </div>
                ) : (
                  <div className="space-y-3 animate-in fade-in duration-500">
                    {allUsers.length === 0 && <p className="text-center text-slate-400 py-10 font-bold tracking-tight">å°šæœªæœ‰ç©å®¶å»ºç«‹æª”æ¡ˆ</p>}
                    {allUsers.sort((a,b) => b.updatedAt - a.updatedAt).map(u => {
                      const completedCount = u.tasks ? u.tasks.filter(v => v).length : 0;
                      return (
                        <button 
                          key={u.id} 
                          onClick={() => setSelectedUser(u)}
                          className="w-full bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center justify-between hover:border-orange-300 transition-all active:scale-[0.98]"
                        >
                          <div className="text-left">
                            <p className="font-black text-slate-800 text-xl">{u.name}</p>
                            <p className="text-[10px] text-orange-600 font-black uppercase tracking-wider">{u.alliance} è¯ç›Ÿ Â· {u.group}</p>
                            <div className="flex gap-1 mt-1">
                              <p className="text-[9px] text-slate-300 font-bold bg-slate-100 px-1 rounded">{u.email || u.loginName}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <div className="text-right">
                              <p className="text-lg font-black text-slate-700">{completedCount}/9</p>
                              <div className="w-20 h-2 bg-slate-100 rounded-full mt-1 overflow-hidden border border-slate-50 shadow-inner">
                                <div className="h-full bg-green-500" style={{ width: `${(completedCount/9)*100}%` }}></div>
                              </div>
                            </div>
                            <ChevronRight size={18} className="text-slate-300" />
                          </div>
                        </button>
                      )
                    })}
                  </div>
                )}
              </React.Fragment>
            ) : (
              <div className="animate-in fade-in zoom-in-95 duration-300 space-y-6 pb-10">
                <button 
                  onClick={() => setSelectedUser(null)} 
                  className="flex items-center gap-1 text-slate-500 font-black hover:text-slate-800 transition-colors bg-white px-5 py-3 rounded-2xl shadow-sm border border-slate-100"
                >
                  <ArrowLeft size={16} /> è¿”å›åˆ—è¡¨
                </button>
                
                <div className="bg-white p-8 rounded-[2.5rem] border border-slate-100 shadow-2xl">
                  <div className="text-center mb-8">
                    <div className="w-20 h-20 bg-orange-100 rounded-[2rem] flex items-center justify-center mx-auto mb-4 rotate-3 shadow-inner">
                      <User size={40} className="text-orange-600 -rotate-3" />
                    </div>
                    <h3 className="text-3xl font-black text-slate-800">{selectedUser.name}</h3>
                    <div className="flex flex-col items-center gap-1 mt-2">
                       <div className="flex items-center gap-2">
                          <span className="px-3 py-1 bg-orange-100 text-orange-600 text-xs font-black rounded-lg">{selectedUser.alliance} è¯ç›Ÿ</span>
                          <span className="text-slate-400 text-xs font-black">{selectedUser.group}</span>
                       </div>
                       <p className="text-[10px] text-slate-300 font-bold mt-1">Email: {selectedUser.email || 'æœªè¨­å®š'}</p>
                       <p className="text-[10px] text-slate-300 font-bold uppercase tracking-tighter leading-none mt-1">å¸³è™Ÿ: {selectedUser.loginName}</p>
                    </div>
                  </div>

                  <div className="space-y-3">
                    <p className="text-xs font-black text-slate-400 uppercase mb-4 tracking-[0.2em] text-center">â€” ä»»å‹™æŒ‘æˆ°è©³ç´°é€²åº¦ â€”</p>
                    {DEFAULT_TASKS.map((task, idx) => (
                      <div key={idx} className={`flex items-center gap-4 p-5 rounded-[1.5rem] border ${selectedUser.tasks && selectedUser.tasks[idx] ? 'bg-green-50/50 border-green-100' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                        {selectedUser.tasks && selectedUser.tasks[idx] 
                          ? <CheckCircle2 size={22} className="text-green-500 shrink-0" />
                          : <div className="w-5 h-5 border-2 border-slate-200 rounded-full shrink-0" />
                        }
                        <span className={`text-base font-black ${selectedUser.tasks && selectedUser.tasks[idx] ? 'text-slate-800' : 'text-slate-400'}`}>
                          {task}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
      </main>

      <footer className="fixed bottom-0 left-0 right-0 bg-white/70 backdrop-blur-lg border-t border-orange-100/50 py-5 text-center z-10">
        <p className="text-[10px] text-slate-400 font-black tracking-widest uppercase tracking-tighter">Life3 Mission Grid Game Â© 2026</p>
      </footer>
    </div>
  );
};

export default App;
